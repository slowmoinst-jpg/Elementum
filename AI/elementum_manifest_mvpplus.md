# Элементум — Итоговый манифест разработки (MVP+)
**Платформа:** Яндекс Игры (Unity 2D WebGL), далее mobile-first  
**Жанр:** Arcade / Roguelite-run (meta прогрессия)  
**Целевая длительность run:** **≥ 2 минуты** на элемент  
**Кульминация:** Collapse на последних **10%** (AntiSpawn=OFF, зачистка обязательна)

> Этот манифест — чеклист. Реализуем строго по порядку. Каждая фича закрывается критериями приемки (DoD) и тест-кейсами.

---

## 0) Конвенции и запреты
- Управление: **клик/тап по протону** (запуск в ядро), **свайп по анти** (урон).
- Свайп **без “точности”** в MVP+. Единственный ограничитель — **HitStun** (визуально «задета»).
- Анти **растут по времени (tiers)**; события (поедание/порча) могут ускорять рост.
- **Collapse**: последние 10% прогресса; **новые анти не спавнятся**.
- Условие победы: `M >= TargetM` **и** `AntiCount == 0`.

---

## 1) Структура проекта
### Папки
- `Assets/_Project/Scenes`
- `Assets/_Project/Prefabs`
- `Assets/_Project/Scripts`
  - `Core/`
  - `Protons/`
  - `Anti/`
  - `Input/`
  - `UI/`
  - `VFX/`
  - `Systems/`
  - `Debug/`
  - `Data/`
- `Assets/_Project/ScriptableObjects`
- `Assets/_Project/Art`
- `Assets/_Project/Audio`

### Сцены
- `Boot` (инициализация, загрузка)
- `MainMenu` (таблица элементов, лаборатория, запуск run)
- `Gameplay_Run`

**DoD**
- [ ] Проект открывается без ошибок
- [ ] Сцены добавлены в Build Settings
- [ ] `Gameplay_Run` запускается без зависимостей от меню (для итераций)

---

## 2) Данные (ScriptableObjects) — основа баланса
### F-01: ScriptableObject схемы
1) `ElementSO`
- `string elementId` (H, He, Li, Be, B)
- `int targetM` (H=100, He=140, Li=180, Be=220, B=260)
- `ElementUnlockBonus` (пассивный бонус — тип/значение; можно stub в MVP+)

2) `RunBalanceSO`
- Протоны: `int protonsOnScreen`, `float protonRespawnDelay`
- Комбо: пороги/множители, условия сброса
- Анти: `AntiTierTimeline` (время → HP tier), `ageBoostOnEat`, `ageBoostOnCorrupt`
- Assault: пороги, drain параметры
- Collapse: `collapseThreshold = 0.9`, suction multipliers, `massShardByTier`
- UI: параметры текста (+M/-M), агрегирование

3) `AntiTypeSO` (по типу анти)
- `enum AntiType { TankEater, FastHunter, Blinker, Corruptor }`
- Базовые: скорость, радиусы, базовый HP, поведение
- Blinker: `freezeTime`, `blinkCooldown`, `blinkTargetMode`
- Corruptor: `convertTime`, `convertCapPerLife`, `convertCreatesAnti = true`
- Ограничения: caps по типам на уровень

4) `CardSO` (карточки)
- id, название, редкость, эффект, длительность (до конца run)
- пул карт (common/rare/legendary)

5) `MetaSO` (лаборатория)
- апгрейды и цены в «Звёздной пыли»

**DoD**
- [ ] Можно создать `ElementSO_H` и др. с нужными TargetM
- [ ] В рантайме текущий элемент и баланс читаются из SO (лог)

---

## 3) Базовый runtime каркас
### F-02: GameState + GameContext
- State: `Playing`, `Paused`, `CardPick`, `Collapse`, `Win`, `Lose`
- `GameContext`: ссылки на ElementSO, RunBalanceSO, ResourceModel, Spawner, UI

**DoD**
- [ ] Переходы стейтов работают (debug hotkeys)
- [ ] В `Win/Lose` игра корректно стопает спавн/ввод

---

## 4) Input (клик/тап/свайп)
### F-03: Unified Input Layer
`InputRouter`:
- Tap on proton: `OnTap(screenPos)`
- Swipe: `OnSwipe(start, end, duration)`

**DoD**
- [ ] Tap выделяет/активирует протон
- [ ] Swipe пересекает анти и наносит hit (если не в HitStun)

---

## 5) Ресурсы и прогресс
### F-04: ResourceModel
- `int M_current`
- `int M_earnedTotal` (всё заработано за run)
- `int M_lostTotal` (всё потеряно за run)
- `int TargetM`
- События для UI: `OnMChanged(delta, reason)`

**DoD**
- [ ] При попадании протона M растёт, earnedTotal растёт
- [ ] При drain M падает, lostTotal растёт
- [ ] Победа проверяется по правилам (см. Collapse)

---

## 6) Протоны на орбитах
### F-05: Proton System (Orbit + Launch)
- Поддержание `protonsOnScreen` (спавн/респавн)
- Движение по орбите (одна/несколько орбит — конфиг)
- Tap → протон переходит в режим `LaunchToCore`
- При достижении ядра: `+M` и протон удаляется/возвращается в пул

**DoD**
- [ ] Протоны стабильны на орбитах
- [ ] Tap отправляет в ядро
- [ ] Попадание всегда даёт `+M`

---

## 7) Античастицы (4 типа) + HitStun
### F-06: Anti Core (Entity + Pool + HP)
- Пул, spawn, базовая навигация к цели
- HP: **минимум 3 hits**
- После успешного хита: `HitStun` (визуально «задета»), пока активен — урон не проходит

**DoD**
- [ ] HitStun ясно виден (flash/дрожь)
- [ ] Спам свайпа не ускоряет убийство

### F-07: Anti Targeting (к ближайшему протону)
- Выбор цели по ближайшему протону
- Движение к цели + окно поедания

**DoD**
- [ ] Анти начинает попытку поедания в разумное время (не «ждать минуту»)

### F-08: Eat / Corrupt действия
- **Eat**: поедание протона → удаление протона
- **Corruptor**: по таймеру конвертации портит протон → создаёт **новую античастицу**
  - `convertCapPerLife` ограничивает лавину
  - учитываем `A_cap` (общий лимит анти): если достигнут — конверсия не создаёт нового anti

**DoD**
- [ ] Corruptor создаёт anti, но не выходит за лимиты
- [ ] Удаление протона корректно влияет на комбо/прогресс

### F-09: Anti Tiers (рост по времени)
- `age` у анти
- Timeline: время → tier → HP (3/4/5…)
- Eat/Corrupt ускоряют возраст (`age += ageBoost`)

**DoD**
- [ ] Анти реально «толстеет» по времени
- [ ] Ошибка игрока (поедание) ускоряет угрозу

---

## 8) Assault (кража массы)
### F-10: Assault Mode
- Условия входа: tier>=T_assault или событий>=N_assault (настройка)
- При касании ядра: `Charge 0.5s` → далее drain тиками
- Drain: `-1M` каждые `0.5s`, максимум N тиков за заход (баланс)

**DoD**
- [ ] Видно/слышно “кражу массы”
- [ ] M уменьшается и отражается UI (+ floating -M)

---

## 9) Collapse (последние 10%)
### F-11: Collapse Trigger + Rules
- Триггер: `M_current >= 0.9 * TargetM`
- State = `Collapse`
- **AntiSpawn = OFF**
- Включить suction для протонов и анти (разные multipliers)
- Победа: `M_current >= TargetM && AntiCount == 0`

**DoD**
- [ ] Collapse включается на 90%
- [ ] Новые анти не появляются
- [ ] Без зачистки анти победа не засчитывается

### F-12: MassShard Rewards (убийство анти помогает добить массу)
- При убийстве anti в Collapse (или всегда): спавн `MassShard` (1–3) по tier
- Shard мгновенно/быстро притягивается к ядру и даёт `+1M` каждый

**DoD**
- [ ] Убийство анти в финале реально помогает закрыть последние проценты

---

## 10) Комбо-система
### F-13: Combo System
- Множители: 1.0 / 1.2 / 1.5 / 2.0 (конфиг)
- Рост комбо: за подряд доставленные протоны без потерь/краж
- Сброс: поедание/порча протона, успешный drain M (Assault)
- Эффект: множитель к `+M` (и опционально небольшой VFX boost)

**DoD**
- [ ] Комбо растёт и даёт ощутимый прирост
- [ ] Ошибки сбрасывают комбо

---

## 11) Карточки (Quantum Boost) на 33% и 66%
### F-14: Card Pick System
- Триггер: при достижении 33% и 66% от TargetM
- Пауза игры, показ 3 карт (случайно из пула с учетом редкости)
- Выбор 1 карты, эффект активен **до конца run**
- Реролл за rewarded ad: **да** (перемешать варианты)

**DoD**
- [ ] Окно выбора срабатывает на нужных порогах
- [ ] Реролл работает
- [ ] Эффекты применяются корректно

---

## 12) UI + VFX фидбек массы (обязательно)
### F-15: HUD M + floating deltas
HUD:
- `M: current / TargetM`
- Прогресс-бар (процент)
- Индикатор комбо `x1.5`

Floating text:
- При попадании протона: `+1M` (или итог с комбо, например `+2M`)
- При drain: `-1M`
- Тексты агрегируются (чтобы не заспамить): несколько событий за 0.2с → один текст `+3M`

End screen:
- `Earned M`, `Lost M`, `Result`

**DoD**
- [ ] Игрок всегда видит общий прогресс
- [ ] Каждое событие имеет понятный +M/-M фидбек
- [ ] Экран результатов показывает earned/lost/итог

---

## 13) Меню, мета и экономика
### F-16: Main Menu (Таблица элементов)
- Показ открытых элементов, следующий доступный
- Запуск run выбранного элемента
- Отображение «Звёздной пыли»

**DoD**
- [ ] Можно выбрать H/He/Li/Be/B (по unlock правилам)

### F-17: Награда «Звёздная пыль»
- За победу выдаётся `dustReward` (зависит от элемента)
- Rewarded ad: **x2 пыль** после run (опционально)

**DoD**
- [ ] Пыль начисляется и сохраняется

### F-18: Лаборатория (перманентные апгрейды)
- Покупка за пыль:
  - `+1 protonsOnScreen` (дорого)
  - `-AssaultDrain%` (сопротивление краже)
  - `AutoCollectChance` (малый шанс авто-поглощения)

**DoD**
- [ ] Апгрейды покупаются и влияют на run

### F-19: Открытие элементов
- После синтеза элемента он помечается как открытый

**DoD**
- [ ] Элементы открываются последовательно

---

## 14) Лидерборд и удержание
### F-20: Leaderboard — «сколько элементов синтезировал»
- Счётчик успешных синтезов (total)
- Отображение лидерборда (интеграция позже; MVP+ может быть stub)

**DoD**
- [ ] Счётчик синтезов растёт после победы
- [ ] Экран лидерборда отображает значения

---

## 15) Монетизация (rewarded ads) — рамки
**Оставляем:**
- Реролл карточек
- x2 пыль после run

**Убираем:**
- Любые «воскрешения» (включая Collapse)

---

## 16) Производительность и качество (WebGL)
### F-21: Pooling + caps
- Пулы: протоны, анти, mass shards, floating texts, VFX
- Caps: max anti, max texts, max particles

**DoD**
- [ ] 60 FPS цель на типичном количестве объектов
- [ ] Нет GC spikes в 2–3 мин run

### F-22: Debug overlay (для тюнинга)
Показывать:
- FPS
- `M current/target`, earned/lost
- active protons / active anti
- anti tiers distribution
- combo state
- collapse flag

**DoD**
- [ ] Оверлей включается/выключается

---

# Релизный чеклист MVP+
- [ ] Run H (TargetM=100) длится в среднем ≥ 120 сек
- [ ] Карты на 33% и 66% работают, есть реролл за рекламу
- [ ] Collapse включается на 90%, анти не спавнятся, зачистка обязательна
- [ ] Corruptor (B) конвертирует протоны в анти, без лавины (ConvertCap + A_cap)
- [ ] +M/-M фидбек в моменте и итоговый отчёт earned/lost
- [ ] Пыль начисляется, лаборатория даёт апгрейды
- [ ] Лидерборд: количество синтезированных элементов
